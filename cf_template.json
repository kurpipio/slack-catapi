{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Api for finding url of random internet cat",
    "Resources": {
	"LambdaExecutionRole": {
	    "Type": "AWS::IAM::Role",
	    "Properties": {
		"RoleName": "RandomCatLambdaIAMRole",
		"AssumeRolePolicyDocument": {
		    "Version": "2012-10-17",
		    "Statement": [{
			"Effect": "Allow",
			"Principal": { "Service": ["lambda.amazonaws.com"] },
			"Action": ["sts:AssumeRole"]
		    }]
		},
		"ManagedPolicyArns": ["arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"]
	    }
	},
	"RandomCatLambda": {
	    "Type": "AWS::Lambda::Function",
	    "Properties": {
		"FunctionName": "GetRandomCat",
		"Description": "Use thecatapi.com to get url of a random cat",
		"Handler": "index.handler",
		"Role": { "Fn::GetAtt": ["LambdaExecutionRole", "Arn"] },
		"Code": { "ZipFile": { "Fn::Join" : ["\n", {% lambda.py %} ]}},
		"Runtime": "python2.7",
		"Timeout": "1"
	    }
	},
	"CatAPI": {
	    "Type": "AWS::ApiGateway::RestApi",
	    "Properties": {
		"Description": "API for finding random internet cats",
		"Name": "CatAPI"
	    }
	},
	"Cat": {
	    "Type": "AWS::ApiGateway::Resource",
	    "Properties": {
		"RestApiId": { "Ref": "CatAPI" },
		"ParentId": { "Fn::GetAtt": ["CatAPI", "RootResourceId"] },
		"PathPart": "cat"
	    }
	},
	"LambdaInvokePermission": {
	    "Type": "AWS::Lambda::Permission",
	    "Properties": {
		"FunctionName" : { "Fn::GetAtt" : ["RandomCatLambda", "Arn"] },
		"Action": "lambda:InvokeFunction",
		"Principal": "apigateway.amazonaws.com",
		"SourceArn": {"Fn::Join" : ["", [
		    "arn:aws:execute-api:",
		    {"Ref": "AWS::Region"},
		    ":",
		    {"Ref": "AWS::AccountId"},
		    ":",
		    {"Ref": "CatAPI"},
		    "/*"
		]]}
	    }
	},
	"GetRandomCat": {
	    "DependsOn": "LambdaInvokePermission",
	    "Type": "AWS::ApiGateway::Method",
	    "Properties": {
		"RestApiId": { "Ref": "CatAPI" },
		"ResourceId": { "Ref": "Cat" },
		"HttpMethod": "POST",
		"AuthorizationType": "NONE",
		"Integration": {
		    "Type": "AWS",
		    "IntegrationHttpMethod": "POST",
		    "PassthroughBehavior": "WHEN_NO_MATCH",
		    "IntegrationResponses": [
			{
			    "ResponseTemplates": {
				"application/json": ""
			    },
			    "StatusCode": "200"
			}
		    ],
		    "Uri": {"Fn::Join" : ["", [
			"arn:aws:apigateway:",
			{"Ref": "AWS::Region"},
			":lambda:path/2015-03-31/functions/",
			{"Fn::GetAtt": ["RandomCatLambda", "Arn"]},
			"/invocations"
		    ]]},
		    "RequestTemplates": {
			"application/x-www-form-urlencoded": { "Fn::Join" : ["\n", {% form_to_json %} ]}}
		},
		"MethodResponses": [
		    {
			"StatusCode": "200"
		    }
		]
	    }
	},
	"ApiGatewayCloudWatchLogsRole": {
	    "Type": "AWS::IAM::Role",
	    "Properties": {
		"RoleName": "GatewayCloudWatchRole",
		"AssumeRolePolicyDocument": {
		    "Version": "2012-10-17",
		    "Statement": [{
			"Effect": "Allow",
			"Principal": { "Service": ["apigateway.amazonaws.com"] },
			"Action": ["sts:AssumeRole"]
		    }]
		},
		"Policies": [{
		    "PolicyName": "ApiGatewayLogsPolicy",
		    "PolicyDocument": {
			"Version": "2012-10-17",
			"Statement": [{
			    "Effect": "Allow",
			    "Action": [
				"logs:CreateLogGroup",
				"logs:CreateLogStream",
				"logs:DescribeLogGroups",
				"logs:DescribeLogStreams",
				"logs:PutLogEvents",
				"logs:GetLogEvents",
				"logs:FilterLogEvents"
			    ],
			    "Resource": "*"
			}]
		    }
		}]
	    }
	},
	"ApiGatewayAccount": {
	    "Type": "AWS::ApiGateway::Account",
	    "Properties": {
		"CloudWatchRoleArn": {"Fn::GetAtt": ["ApiGatewayCloudWatchLogsRole", "Arn"] }
	    }
	},
	"ApiDeployment": {
	    "Type": "AWS::ApiGateway::Deployment",
	    "DependsOn": ["GetRandomCat"],
	    "Properties": {
		"RestApiId": {"Ref": "CatAPI"},
		"StageName": "PROD"
	    }
	}
    },
    "Outputs": {
	"RootUrl": {
	    "Description": "Root URL of the API gateway",
	    "Value": {"Fn::Join": ["", ["https://", {"Ref": "CatAPI"}, ".execute-api.", {"Ref": "AWS::Region"}, ".amazonaws.com/PROD/cat"]]}
	}
    }
}
